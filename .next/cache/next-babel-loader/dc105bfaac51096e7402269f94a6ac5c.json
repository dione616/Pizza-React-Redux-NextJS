{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport auth0 from \"auth0-js\";\nimport Cookies from \"js-cookie\";\nimport axios from \"axios\";\nimport jwt from \"jsonwebtoken\";\nimport getConfig from \"next/config\";\nimport { getCooksFromReq } from \"../lib/utils\";\n\nvar _getConfig = getConfig(),\n    publicRuntimeConfig = _getConfig.publicRuntimeConfig;\n\nvar Auth0 = /*#__PURE__*/function () {\n  function Auth0() {\n    _classCallCheck(this, Auth0);\n\n    this.auth0 = new auth0.WebAuth({\n      domain: \"dione616.eu.auth0.com\",\n      clientID: \"\".concat(publicRuntimeConfig.client_id),\n      redirectUri: \"\".concat(publicRuntimeConfig.base_url, \"/login-success\"),\n      responseType: \"token id_token\",\n      scope: \"openid\"\n    }); //if call from another context, need to bind or arrow func\n\n    this.handleAuthentication = this.handleAuthentication.bind(this);\n    this.isAuthenticated = this.isAuthenticated.bind(this);\n  }\n\n  _createClass(Auth0, [{\n    key: \"handleAuthentication\",\n    value: function handleAuthentication() {\n      var _this = this;\n\n      return new Promise(function (resolve, reject) {\n        _this.auth0.parseHash(function (err, authResult) {\n          if (authResult && authResult.accessToken && authResult.idToken) {\n            _this.setSession(authResult);\n\n            resolve();\n          } else if (err) {\n            reject();\n          }\n        });\n      });\n    }\n  }, {\n    key: \"setSession\",\n    value: function setSession(authResult) {\n      var expiresAt = JSON.stringify(authResult.expiresIn * 1000 + new Date().getTime());\n      Cookies.set(\"x-jwt-exp\", expiresAt);\n      Cookies.set(\"x-jwt\", authResult.idToken);\n    }\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      Cookies.remove(\"x-jwt-exp\");\n      Cookies.remove(\"x-jwt\");\n    }\n  }, {\n    key: \"login\",\n    value: function login() {\n      this.auth0.authorize();\n    }\n  }, {\n    key: \"getJWKS\",\n    value: function () {\n      var _getJWKS = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var res, jwks;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return axios.get(\"https://dione616.eu.auth0.com/.well-known/jwks.json\");\n\n              case 2:\n                res = _context.sent;\n                jwks = res.data;\n                return _context.abrupt(\"return\", jwks);\n\n              case 5:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      function getJWKS() {\n        return _getJWKS.apply(this, arguments);\n      }\n\n      return getJWKS;\n    }()\n  }, {\n    key: \"certToPEM\",\n    value: function certToPEM(cert) {\n      cert = cert.match(/.{1,64}/g).join(\"\\n\");\n      cert = \"-----BEGIN CERTIFICATE-----\\n\".concat(cert, \"\\n-----END CERTIFICATE-----\\n\");\n      return cert;\n    }\n  }, {\n    key: \"verifyToken\",\n    value: function () {\n      var _verifyToken = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(token) {\n        var jwks, certificate, decodedVerify, expiresAt;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (!token) {\n                  _context2.next = 14;\n                  break;\n                }\n\n                _context2.next = 3;\n                return this.getJWKS();\n\n              case 3:\n                jwks = _context2.sent;\n                certificate = this.certToPEM(jwks.keys[0].x5c[0]);\n                _context2.prev = 5;\n                decodedVerify = jwt.verify(token, certificate);\n                expiresAt = decodedVerify.exp * 1000;\n                return _context2.abrupt(\"return\", decodedVerify && new Date().getTime() < expiresAt ? true : false);\n\n              case 11:\n                _context2.prev = 11;\n                _context2.t0 = _context2[\"catch\"](5);\n                return _context2.abrupt(\"return\", false);\n\n              case 14:\n                return _context2.abrupt(\"return\", false);\n\n              case 15:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this, [[5, 11]]);\n      }));\n\n      function verifyToken(_x) {\n        return _verifyToken.apply(this, arguments);\n      }\n\n      return verifyToken;\n    }()\n  }, {\n    key: \"isAuthenticated\",\n    value: function () {\n      var _isAuthenticated = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(req) {\n        var token, verifyToken, _token, _verifyToken2;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (!true) {\n                  _context3.next = 8;\n                  break;\n                }\n\n                //client\n                token = Cookies.get(\"x-jwt\");\n                _context3.next = 4;\n                return this.verifyToken(token);\n\n              case 4:\n                verifyToken = _context3.sent;\n                return _context3.abrupt(\"return\", verifyToken);\n\n              case 8:\n                //server\n                _token = getCooksFromReq(req, \"x-jwt\");\n                _context3.next = 11;\n                return this.verifyToken(_token);\n\n              case 11:\n                _verifyToken2 = _context3.sent;\n                return _context3.abrupt(\"return\", _verifyToken2);\n\n              case 13:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function isAuthenticated(_x2) {\n        return _isAuthenticated.apply(this, arguments);\n      }\n\n      return isAuthenticated;\n    }()\n  }]);\n\n  return Auth0;\n}();\n\nvar auth0Serv = new Auth0();\nexport default auth0Serv;","map":{"version":3,"sources":["E:/ProgramingTraining/Courses/2020/Coding Revolution Next Redux/pizzeria/lib/appAuth.js"],"names":["auth0","Cookies","axios","jwt","getConfig","getCooksFromReq","publicRuntimeConfig","Auth0","WebAuth","domain","clientID","client_id","redirectUri","base_url","responseType","scope","handleAuthentication","bind","isAuthenticated","Promise","resolve","reject","parseHash","err","authResult","accessToken","idToken","setSession","expiresAt","JSON","stringify","expiresIn","Date","getTime","set","remove","authorize","get","res","jwks","data","cert","match","join","token","getJWKS","certificate","certToPEM","keys","x5c","decodedVerify","verify","exp","req","verifyToken","auth0Serv"],"mappings":"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","sourcesContent":["import auth0 from \"auth0-js\"\r\nimport Cookies from \"js-cookie\"\r\nimport axios from \"axios\"\r\nimport jwt from \"jsonwebtoken\"\r\n\r\nimport getConfig from \"next/config\"\r\nimport { getCooksFromReq } from \"../lib/utils\"\r\n\r\nconst { publicRuntimeConfig } = getConfig()\r\n\r\nclass Auth0 {\r\n  constructor() {\r\n    this.auth0 = new auth0.WebAuth({\r\n      domain: \"dione616.eu.auth0.com\",\r\n      clientID: `${publicRuntimeConfig.client_id}`,\r\n      redirectUri: `${publicRuntimeConfig.base_url}/login-success`,\r\n      responseType: \"token id_token\",\r\n      scope: \"openid\",\r\n    })\r\n    //if call from another context, need to bind or arrow func\r\n    this.handleAuthentication = this.handleAuthentication.bind(this)\r\n    this.isAuthenticated = this.isAuthenticated.bind(this)\r\n  }\r\n\r\n  handleAuthentication() {\r\n    return new Promise((resolve, reject) => {\r\n      this.auth0.parseHash((err, authResult) => {\r\n        if (authResult && authResult.accessToken && authResult.idToken) {\r\n          this.setSession(authResult)\r\n          resolve()\r\n        } else if (err) {\r\n          reject()\r\n        }\r\n      })\r\n    })\r\n  }\r\n\r\n  setSession(authResult) {\r\n    let expiresAt = JSON.stringify(authResult.expiresIn * 1000 + new Date().getTime())\r\n    Cookies.set(\"x-jwt-exp\", expiresAt)\r\n    Cookies.set(\"x-jwt\", authResult.idToken)\r\n  }\r\n\r\n  logout() {\r\n    Cookies.remove(\"x-jwt-exp\")\r\n    Cookies.remove(\"x-jwt\")\r\n  }\r\n\r\n  login() {\r\n    this.auth0.authorize()\r\n  }\r\n\r\n  async getJWKS() {\r\n    const res = await axios.get(\"https://dione616.eu.auth0.com/.well-known/jwks.json\")\r\n    const jwks = res.data\r\n    return jwks\r\n  }\r\n\r\n  certToPEM(cert) {\r\n    cert = cert.match(/.{1,64}/g).join(\"\\n\")\r\n    cert = `-----BEGIN CERTIFICATE-----\\n${cert}\\n-----END CERTIFICATE-----\\n`\r\n    return cert\r\n  }\r\n\r\n  async verifyToken(token) {\r\n    if (token) {\r\n      const jwks = await this.getJWKS()\r\n      const certificate = this.certToPEM(jwks.keys[0].x5c[0])\r\n\r\n      try {\r\n        const decodedVerify = jwt.verify(token, certificate)\r\n        const expiresAt = decodedVerify.exp * 1000\r\n\r\n        return decodedVerify && new Date().getTime() < expiresAt ? true : false\r\n      } catch {\r\n        return false\r\n      }\r\n    }\r\n    return false\r\n  }\r\n\r\n  async isAuthenticated(req) {\r\n    if (process.browser) {\r\n      //client\r\n      const token = Cookies.get(\"x-jwt\")\r\n      const verifyToken = await this.verifyToken(token)\r\n\r\n      return verifyToken\r\n    } else {\r\n      //server\r\n      const token = getCooksFromReq(req, \"x-jwt\")\r\n      const verifyToken = await this.verifyToken(token)\r\n\r\n      return verifyToken\r\n    }\r\n  }\r\n}\r\nconst auth0Serv = new Auth0()\r\nexport default auth0Serv\r\n"]},"metadata":{},"sourceType":"module"}